{% extends "layout.html" %}
{% from "baseframe/forms.html" import renderform, ajaxform %}
{% block headline %}
  <h3><a href="{{ channel.url_for() }}">{{ channel.title }}</a> &rsaquo;
      <a href="{{ playlist.url_for() }}">{{ playlist.short_title or playlist.title }}</a> &rsaquo;</h3>
  <h1>{{ video.title }}</h1>
{% endblock %}

{% block pageheaders %}
  <link rel="canonical" href="{{ video.url_for('view', _external=True) }}"/>
{% endblock %}

{% block content %}
  <div class="row">
    <div class="span6">
      <div class="video169">
        {{ video.embed_video_for('view') }}
      </div>
    </div>
    <div class="span6">
      {% with slides_html = video.embed_slides_for('view') %}
        {%- if slides_html %}
          <div class="video169">
            {{ slides_html }}
          </div>
        {%- else -%}
          <div class="video169 placeholder">
            No slides available
          </div>
        {%- endif %}
      {% endwith %}
    </div>
  </div>
  {% if playlist != video.playlist -%}
    <br/>Uploaded in <a href="{{video.playlist.url_for('view')}}">{{ video.playlist.title }}</a>
  {%- endif %}
  {% if g.user %}<form id="action" method="POST" action="{{ video.url_for('action') }}" class="unstyled">
    {{ form.csrf_token() }}
    <div class="btn-toolbar">
      <div class="btn-group" data-toggle="buttons-checkbox">
        <button class="btn {%- if flags['starred'] %} active{% endif %}" title="Star" name="action" value="star"><i class="icon-star"></i></button>
        <button class="btn {%- if flags['queued'] %} active{% endif %}" title="Add to Queue" name="action" value="queue"><i class="icon-time"></i></button>
      </div>
      <div class="btn-group" data-toggle="buttons-radio">
        <button class="btn {%- if flags['liked'] %} active{% endif %}" title="Like" name="action" value="like"><i class="icon-thumbs-up"></i> Like</button>
        <button class="btn {%- if flags['disliked'] %} active{% endif %}" title="Dislike" name="action" value="dislike"><i class="icon-thumbs-down"></i></button>
      </div>
      <div class="btn-group dropup">
        {%- if 'remove-video' in g.permissions -%}
          <a class="btn" href="{{ video.url_for('remove') }}" title="Remove from this playlist"><i class="icon-minus"></i> Remove</a>
        {%- endif %}
        <a class="btn dropdown-toggle" data-toggle="dropdown"><i class="icon-plus"></i> Add to <span class="caret"></span></a>
        <div class="playlists">
        </div>
      </div>
      {% if 'edit' in g.permissions -%}
        <div class="btn-group">
          <a class="btn" href="{{ video.url_for('edit') }}"><i class="icon-pencil"></i> Edit</a>{#
          #}<a class="btn" href="{{ video.url_for('delete') }}"><i class="icon-trash"></i> Delete...</a>
        </div>
      {%- endif %}
      <span class="loading hidden">&nbsp;</span>
    </div>
  </form>{% endif %}
  <div class='modal hide' id='playlist-modal'>
    <div class='modal-header'>
        <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>X</button>
        <h3 id='myModalLabel'>New Playlist</h3>
    </div>
    <div class='modal-body'><form action="{{ url_for('playlist_new_modal', channel=channel.name) }}" method='POST' id='modal-form'> {{ form.csrf_token() }}
    <div class='error-indicator'><div class='alert alert-error hidden'><a class='close' data-dismiss='alert'>×</a>Please correct the indicated errors.</div></div>
      <div class='control-group' id='field-title'>
        <label class='control-label' for='title'>Title <span class='help-required' title='Required'>*</span></label>
        <div class='controls'><input autofocus='autofocus' class='field-title' id='title' name='title' type='text' value=''>
          <p class='help-error hidden' id='title_error'><span>This field is required.</span></p>
          <p class='help-block'>The name of your playlist</p>
          <div class='control-group' id='field-short_title'>
            <label class='control-label' for='short_title'>Short title </label>
            <div class='controls'>
              <input class='field-short_title' id='short_title' name='short_title' type='text' value=''>
              <p class='help-error hidden' id='short_title_error'><span>This field is required.</span></p>
              <p class='help-block'>Shorter title, displayed next to the channel's name when viewing a video</p>
            </div>
          </div>
        </div>
        </div>
        <div class='control-group' id='field-name'>
          <label class='control-label' for='name'>URL Name </label>
          <div class='controls'>
            <input class='field-name' id='name' name='name' type='text' value=''>
            <p class='help-error hidden' id='name_error'><span>This field is required.</span></p>
            <p class='help-block'>Optional. Will be automatically generated if left blank</p>
          </div>
        </div>
        <div class='control-group' id='field-description'>
          <label class='control-label' for='description'>Description </label>
          <div class='controls'>
            <textarea class='richtext field-description' id='description' name='description'></textarea>
            <p class='help-error hidden' id='short_title_error_description'><span>This field is required.</span></p>
          </div>
        </div>
        <div class='control-group' id='field-recorded_date'>
          <label class='control-label' for='recorded_date'>Recorded date </label>
          <div class='controls'>
            <input class='field-recorded_date' id='recorded_date' name='recorded_date' type='text' value=''>
            <p class='help-error hidden' id='recorded_date_error'><span>This field is required.</span></p>
            <p class='help-block'>Date on which the videos in this playlist were recorded, if applicable</p>
          </div>
        </div>
        <div class='control-group' id='field-published_date'>
          <label class='control-label' for='published_date'>Published date <span class='help-required' title='Required'>*</span></label>
          <div class='controls'>
            <input class='field-published_date' id='published_date' name='published_date' type='text'>
            <p class='help-error hidden' id='published_date_error'><span>This field is required.</span></p>
            <p class='help-block'>Date on which this playlist was created or made public</p>
          </div>
        </div>
        <div class='control-group' id='field-public'>
          <div class='controls inline'>
              <input checked class='field-public' id='public' name='public' tabindex='' type='checkbox' value='y'>
              <label for='public'>This playlist is public</label>
            </div>
          </div>
        </div>
        <div class='modal-footer'>
          <button class='btn' data-dismiss='modal' aria-hidden='true'>Cancel</button>
          <button class='btn btn-primary' id='modal-create'>Create</button>
        </div>
      </form>
    </div>
  {% if speakers %}
    <h3>Speakers </h3>
    {% for speaker in speakers %}
      <li><a href="{{ speaker.playlist_for_speaking_in().url_for('view') }}">{{ speaker.title }}</a></li>
    {% endfor %}
  {% endif %}
{% endblock %}
{% block footerscripts %}
  <script type="text/javascript">
    $(function() {
      var playlist_action = function(url, data, type) {
        $.ajax({
          type: type,
          url: url,
          data: data,
          success: function(msg) {
            if (msg['message_type'] === 'success') {
              if (msg['action'] === 'append') {
                $(".playlists").append(msg['html']);
              }
              else if (msg['action'] === 'add') {
                // Get the playlist user clicked
                var to_append = $('.playlists [data="'+msg['playlist_name']+'"]');
                // <i class='icon-ok'></i> is bootstrap icon to display tick mark
                var icon_to_display = to_append.find('i');
                if (to_append.length === 1 && icon_to_display.length === 1) {
                  icon_to_display.show('i');
                }
                else {
                  to_append.append("<i class='icon-ok'></i>");
                }
              }
              else if (msg['action'] === 'delete') {
                var to_hide = $('.playlists [data="'+msg['playlist_name']+'"]');
                if (to_hide.length === 1) {
                  to_hide.find('i').hide();
                }
              }
              if (msg['message']) {
                toastr.success(msg['message']);
              }
            }
            else if (msg['message_type'] === 'error') {
              if (msg['message']) {
                toastr.error(msg['message']);
              }
            }
            else if (msg['message_type'] === 'info') {
              if (msg['message']) {
                toastr.info(msg['message']);
              }
            }
          },
          error: function() {
            toastr.error("Something went wrong, please try again");
          }
        });
      }
      $("#action").ajaxForm({
        beforeSubmit: function(){
          $(".loading").removeClass('hidden');
        },
        success: function(msg) {
          $(".loading").addClass('hidden');
          var action = $(this).attr('data').split('action=').pop();
          if (["dislike", "like"].indexOf(action) !== -1 && msg['message_type'] === 'removed') {
            $(".btn[value='" + action + "']").removeClass('active');
          }
          if (msg['message_type'] === 'added' || msg['message_type'] === 'removed') {
            toastr.success(msg['message']);
          } else if (msg['message_type'] === 'failure') {
            toastr.error(msg['message']);
          }
        },
        error: function() {
          $(".loading").addClass('hidden');
          toastr.error("Something went wrong, please try again");
        },
      });
      /* Add To Button click */
      $(".dropdown-toggle").on('click', function(event) {
        event.preventDefault();
        //$('.modal').modal('hide');
        if ($('.dropdown-menu').length === 0) {
          playlist_action("{{ channel.url_for('all-playlist') }}", {
            video_name: "{{ video.name }}",
            csrf_token: $('input[name="csrf_token"]').val(),
          }, "GET");
        }
      });
      /* Add to playlist */
      $(".playlists").on('click', "#playlist-item", function(event) {
        event.preventDefault();
        var playlist_name = $(this).attr('data');
        if (playlist_name !== "new-playlist") {
          playlist_action("{{ channel.url_for('action') }}", {
            playlist_name: playlist_name,
            video_name: "{{ video.name }}",
            csrf_token: $('input[name="csrf_token"]').val(),
          }, "POST");
        } else if (playlist_name === "new-playlist") {
          $("#playlist-modal").modal({show: true, keyboard: true}).bind('click keydown', function(event) {
            //code for on enter keypress & submit button
            var modalWindow = $(this);
            if (event.target.id === 'modal-create' || event.keyCode === 13) {
              event.preventDefault();
              $("#modal-form").ajaxSubmit({
                success: function(msg) {
                  if (msg['message_type'] === 'success') {
                    if (msg['action'] === 'append') {
                      $('#playlist-items').append(msg['html']);
                    }
                  modalWindow.modal('hide');
                  toastr.success(msg['message']);
                  } else if (msg['message_type'] === 'error') {
                      /* Here form validation error message from server is displayed.
                         Error messages are hidden with `hidden` class and after validation
                         `hidden` class is removed depending on error field.
                       */
                      if ($('.alert-error').length !== 0) { //If user closes the error message
                        if ($('.alert-error').hasClass('hidden')) { // Enable Please correct following items error message
                          $('.alert-error').removeClass('hidden');
                        }
                      } else {
                        $('.error-indicator').append("<div class='alert alert-error'><a class='close' data-dismiss='alert'>×</a>Please correct the indicated errors.</div>")
                      }
                      $('.help-error').map(function(index, item){
                        //help-error corresponds to class of error text
                        //msg['html'] contains array of error fields id
                        if (msg['html'].indexOf(item.id) !== -1) {
                          if ($(item).hasClass('hidden')){
                            $(item).removeClass('hidden');
                          }
                        } else if (!$(item).hasClass('hidden')) {
                            $(item).addClass('hidden');
                          }
                      });
                    }
                },
                error: function(msg) { toastr.error("something went wrong try later") }
              });
            }
          });
        }
      });
    });
 </script>
{% endblock %}
